#!/bin/bash

# 定义变量
APT_SOURCES="/etc/apt/sources.list"
BACKUP_SOURCES="$APT_SOURCES.bak"
KKFILEVIEW_DIR="/opt/kkfileview"

# 备份当前的 sources.list 文件
if [ -f "$APT_SOURCES" ]; then
    mv "$APT_SOURCES" "$BACKUP_SOURCES"
else
    echo "Error: $APT_SOURCES not found."
    exit 1
fi

apt update

# 安装必要的工具和依赖
apt install maven git -y

# 克隆并编译项目
mkdir "$KKFILEVIEW_DIR" && cd "$KKFILEVIEW_DIR"

# Maven 编译
if [ -d "$KKFILEVIEW_DIR" ]; then
    # Git 操作
    git init
    git remote add origin https://github.com/kekingcn/kkFileView/tree/kl.git
    git config core.sparseCheckout true

    # 配置 sparse-checkout
    echo 'server' >> .git/info/sparse-checkout
    echo 'pom.xml' >> .git/info/sparse-checkout
    echo '!server/LibreOfficePortable' >> .git/info/sparse-checkout

    # 拉取代码
    git pull origin master
else
    echo "Error: Git Clone Error ."
    exit 1
fi



# 移动文件
mv /opt/CloudreveController.java "$KKFILEVIEW_DIR/server/src/main/java/cn/keking/model/"

# Maven 编译
# Maven 编译
if [ -d "$KKFILEVIEW_DIR" ]; then
    mvn clean package -DskipTests
    cd /opt
else
    echo "Error: Maven ."
    exit 1
fi


# 清理项目目录
rm -rf "$KKFILEVIEW_DIR/server/src/test"
rm -rf "$KKFILEVIEW_DIR/server/src/main/bin/"*
rm -rf "$KKFILEVIEW_DIR/server/src/main/java"
rm -rf "$KKFILEVIEW_DIR/server/src/main/resources"

# 复制 JAR 文件
cp "$KKFILEVIEW_DIR/server/target/kkFileView"*".jar" "$KKFILEVIEW_DIR/server/src/main/bin/kkFileView.jar"

# 清理不必要的文件和目录
rm -rf "$KKFILEVIEW_DIR/server/pom.xml"
rm -rf "$KKFILEVIEW_DIR/server/target" 
rm -rf "$KKFILEVIEW_DIR/pom.xml" 
rm -rf "$KKFILEVIEW_DIR/.git"

# 打包
tar -zcvf kkfileview.tar.gz ./kkfileview
