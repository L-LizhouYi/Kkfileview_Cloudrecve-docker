#!/bin/bash

set -e

# 定义变量
APT_SOURCES="/etc/apt/sources.list"
BACKUP_SOURCES="$APT_SOURCES.bak"
LIBREOFFICE_ARCHIVE="/opt/LibreOffice_7.6.4_Linux_x86-64_deb.tar.gz"
FONTS_ARCHIVE="/opt/fonts.zip"
LIBREOFFICE_DIR="/opt/LibreOffice_7.6.4.1_Linux_x86-64_deb"

# 错误处理函数
error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# 备份当前的 sources.list 文件
if [ -f "$APT_SOURCES" ]; then
    mv "$APT_SOURCES" "$BACKUP_SOURCES" || error_exit "Failed to backup sources.list"
else
    error_exit "$APT_SOURCES not found."
fi

# 更新 apt 缓存
apt update || error_exit "Failed to update apt cache"

# 安装 LibreOffice 依赖
apt install libxinerama1 libnss3-tools libdbus-1-3 libcairo2 libglib2.0-0 libcups2 fontconfig xfonts-utils openjdk-11-jdk curl unzip -y || error_exit "Failed to install dependencies"

# 下载所需文件
curl -o "$LIBREOFFICE_ARCHIVE" http://archive.ubuntu.com/ubuntu/pool/main/libr/libreoffice/libreoffice_24.8.2-0ubuntu1.debian.tar.xz || error_exit "Failed to download LibreOffice archive"
curl -o "$FONTS_ARCHIVE" https://kkfileview.keking.cn/fonts.zip || error_exit "Failed to download fonts archive"

# 解压文件
cd /opt || error_exit "Failed to change directory to /opt"
tar zxf "$LIBREOFFICE_ARCHIVE" || error_exit "Failed to extract LibreOffice archive"
unzip "$FONTS_ARCHIVE" || error_exit "Failed to extract fonts archive"

# 安装字体
if [ -d "/opt/zhFonts" ]; then
    mv /opt/zhFonts/* /usr/share/fonts || error_exit "Failed to move fonts to /usr/share/fonts"
    cd /usr/share/fonts && mkfontscale && mkfontdir && fc-cache || error_exit "Failed to update font cache"
else
    error_exit "/opt/zhFonts directory not found."
fi

# 安装 LibreOffice
if [ -d "$LIBREOFFICE_DIR" ]; then
    dpkg -i "$LIBREOFFICE_DIR"/DEBS/*.deb || error_exit "Failed to install LibreOffice"
else
    error_exit "$LIBREOFFICE_DIR directory not found."
fi

cd /opt && tar -xvf kkfileview.tar.gz || error_exit "Failed to tar kkfileview"
mv /opt/start.sh /opt/kkfileview/server/src/main/bin/ || error_exit "Failed to move start.sh"
chmod +x /opt/kkfileview/server/src/main/bin/start.sh || error_exit "Failed to chmod +x start.sh"

# 清理临时文件
rm -rf "$LIBREOFFICE_ARCHIVE" "$FONTS_ARCHIVE" "$LIBREOFFICE_DIR" /opt/zhFonts /opt/kkfileview.tar.gz

# 删除优化脚本自身
rm -f "$0"
